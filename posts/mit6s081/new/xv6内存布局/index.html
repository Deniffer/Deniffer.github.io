<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>xv6内存布局 - Deniffer's Blog</title><meta name=author content="Deniffer"><meta name=author-link content="https://blog.deniffer.com"><meta name=description content="Blog"><meta name=keywords content="deniffer,blog"><meta itemprop=name content="xv6内存布局"><meta itemprop=description content><meta itemprop=datePublished content="2023-03-20T22:33:19+08:00"><meta itemprop=dateModified content="2023-03-20T22:33:19+08:00"><meta itemprop=wordCount content="5078"><meta itemprop=keywords content><meta property="og:title" content="xv6内存布局"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://blog.deniffer.com/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-20T22:33:19+08:00"><meta property="article:modified_time" content="2023-03-20T22:33:19+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="xv6内存布局"><meta name=twitter:description content><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.deniffer.com/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/><link rel=prev href=https://blog.deniffer.com/posts/mit6s081/new/%E5%89%8D%E8%A8%80lab-utility/><link rel=next href=https://blog.deniffer.com/posts/mit6s081/new/c%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0riscv%E8%99%9A%E6%8B%9F%E6%9C%BA/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"xv6内存布局","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.deniffer.com\/posts\/mit6s081\/new\/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80\/"},"genre":"posts","wordcount":5078,"url":"https:\/\/blog.deniffer.com\/posts\/mit6s081\/new\/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80\/","datePublished":"2023-03-20T22:33:19+08:00","dateModified":"2023-03-20T22:33:19+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Deniffer"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('data-theme','dark')</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Deniffer's Blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.svg data-srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" data-sizes=auto alt="Deniffer's Blog" title="Deniffer's Blog"><span class=header-title-text> Deniffer's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/ title=展示所有文章><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/ title=根据分类查找文章><i class="fa-solid fa-folder-open fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/ title=寻找所有标签><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/ title=关于作者的个人信息><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Deniffer's Blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.svg data-srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" data-sizes=auto alt=/logo.svg title=/logo.svg><span class=header-title-text> Deniffer's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/ title=展示所有文章><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/ title=根据分类查找文章><i class="fa-solid fa-folder-open fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/ title=寻找所有标签><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/ title=关于作者的个人信息><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><main class=container data-page-style=wide><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>xv6内存布局</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.deniffer.com title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src=https://oss-cdn.deniffer.com/blog/avatar.png data-srcset="https://oss-cdn.deniffer.com/blog/avatar.png, https://oss-cdn.deniffer.com/blog/avatar.png 1.5x, https://oss-cdn.deniffer.com/blog/avatar.png 2x" data-sizes=auto alt=Deniffer title=Deniffer>&nbsp;Deniffer</a></span></div><div class=post-meta-line><span title="2023-03-20 22:33:19"><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-03-20>2023-03-20</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i> 约 5078 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden=true></i> 预计阅读 11 分钟</span>&nbsp;<span id=/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ class="leancloud_visitors comment-visitors" data-flag-title=xv6内存布局>
<i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count>-</span>&nbsp;次阅读
</span>&nbsp;<span class=comment-count data-flag-title=xv6内存布局>
<i class="fa-regular fa-comments fa-fw" aria-hidden=true></i>&nbsp;<span data-xid=/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ class=valine-comment-count>-</span>&nbsp;条评论
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#用户进程的内存布局>用户进程的内存布局</a></li><li><a href=#kernel-的内存布局>kernel 的内存布局</a></li><li><a href=#lab-pgtable>LAB pgtable</a><ul><li><a href=#print-a-page-table-easy>print a page table (easy)</a></li><li><a href=#a-kernel-page-table-per-process-hardhttpspdoscsailmitedu6s0812020labsguidancehtml>A kernel page table per process (<a href=https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html>hard</a>)</a></li><li><a href=#simplify-copyincopyinstr-hardhttpspdoscsailmitedu6s0812020labsguidancehtml>Simplify <code>copyin/copyinstr</code> (<a href=https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html>hard</a>)</a></li><li><a href=#optional-challengge-exercises>Optional Challengge exercises</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=注>注</h1><blockquote><p>聊聊xv6的内存布局 以及更详细的一些关于页面的知识</p></blockquote><h3 id=用户进程的内存布局>用户进程的内存布局</h3><figure align=center><img src=/img/image-20230302215107415.png alt width=70% height=70%>
<figcation>用户进程内存布局</figcation></figure><h3 id=kernel-的内存布局>kernel 的内存布局</h3><p>Trampoline ->0x3fffff000 - 0x40000000</p><p>Trapframe -> 0x3ffffe000 - 0x3fffff000</p><p>kernelstack for first process -> 0x3ffffd000 - 0x3ffffe000</p><p>Guard page -> 0x3ffffc000 - 0x3ffffd000</p><p>Kernelstack for second process ->0x3ffffb000 - 0x3ffffc000</p><p>Guard page -> 0x3ffffa000 - 0x3ffffb000</p><p>&mldr;.</p><figure align=center><img src=/img/image-20230302095058061.png alt width=50% height=50%>
<figcation>xv6 vitual mem和physical mem</figcation></figure><ol><li><p>理解操作系统是怎么感知到空闲内存的, freerange函数,挂上一个free_mem链表, 想想可以有别的方法吗? 比如我想设置多种不同大小的pagesize, 比如 4KB/8KB/512KB/1MB/4MB/8MB/16MB等, 我该怎么写?</p><p><code>hints: multiple LinkedList</code></p></li><li><p>理解trampoline 和kstack的本质是什么, 为什么映射的物理地址是这样子的 , trampoline和kstack的本质是什么?</p><p><code>hints: the content they saved</code></p></li><li><p>Xv6 是怎么引导到main函数执行的? 在lab2 syscall的时候,我们知道用户程序是通过elf.entry 来指定程序入口为main, 那xv6又是怎么做到的呢?</p><p><code>hints: start.c, entry.S? 为什么entry.S可以直接call start?</code></p></li><li><p>如何读懂Makefile -> kernel.ld</p></li><li><p>如何看懂pgtable ,pgtable是va还是pa?</p></li><li><p>用户进程的kstack 是用来干嘛的?</p><p><code>Hints: 假设用户程序执行syscall 然后来了个clock interrupt 会发生什么事情?</code></p></li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/image-20230302215441312.png data-srcset="/img/image-20230302215441312.png, /img/image-20230302215441312.png 1.5x, /img/image-20230302215441312.png 2x" data-sizes=auto alt=image-20230302215441312 title=image-20230302215441312></p><h3 id=lab-pgtable>LAB pgtable</h3><h4 id=print-a-page-table-easy>print a page table (easy)</h4><blockquote><p>Define a function called <code>vmprint()</code>. It should take a <code>pagetable_t</code> argument, and print that pagetable in the format described below. Insert <code>if(p->pid==1) vmprint(p->pagetable)</code> in exec.c just before the <code>return argc</code>, to print the first process&rsquo;s page table. You receive full credit for this assignment if you pass the <code>pte printout</code> test of <code>make grade</code>.</p></blockquote><ul><li>在kernel/vm.c 实现vmprint的逻辑 并在defs.h上进行声明, 这可以让其他文件使用vmprint函数</li><li>仔细学习freewalk函数</li><li>使用%p来打印64bits 的PTEs 还有对应的地址</li></ul><h4 id=a-kernel-page-table-per-process-hardhttpspdoscsailmitedu6s0812020labsguidancehtml>A kernel page table per process (<a href=https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html target=_blank rel="external nofollow noopener noreferrer">hard</a>)</h4><blockquote><p>Your first job is to modify the kernel so that every process uses its own copy of the kernel page table when executing in the kernel. Modify <code>struct proc</code> to maintain a kernel page table for each process, and modify the scheduler to switch kernel page tables when switching processes. For this step, each per-process kernel page table should be identical to the existing global kernel page table. You pass this part of the lab if <code>usertests</code> runs correctly.</p></blockquote><ul><li>往struct proc 添加一个 kernel_pgtable 的指针</li><li>实现一个改良版的kvminit, 使得可以在allocproc的时候调用这个函数</li><li>确保用户进程的内核页表拥有对应 的kernel stack , 你需要修改procinit 并将对应逻辑放到allocproc这个函数里</li><li>修改scheduler函数, 使得satp寄存器指向用户进程的内核页表,当你调用w_satp()的时候, 不要忘记调用sfence_vma() ,scheduler应该使用内核页表,当没有用户进程在运行的时候</li><li>在freeproc中 释放用户进程的内核页表, 但是不要释放真正的内核页表</li><li>你可以在kernel.asm中 看到究竟是哪一行代码导致的page fault</li></ul><p>这个kernel page per process 很多MIT本科生刷的时候都觉得很难的, 所以大家不要妄自菲薄, 最关键的问题在于你是否对xv6有了足够深刻的认识, 你才能很好的做完这个lab. 我来分析一下我是怎么实现这个lab的.</p><ol><li>首先很直观的想法, 就是往用户页表里面copy 一份内核页表, 并添加对应 的mapping, 但其实你会发现这样做是不可行的, 因为如果其他用户进程修改了某些内核的数据,这会导致数据不一致的问题.</li><li>那么我们该怎么做呢? 思考一下xv6三级页表的结构,每一级页表都是存储对下一级页表的索引, 再仔细想想,我是不是只需要复制内核页表的一级页表就可以了, 于是我们可以kalloc 一个page, 并将一级页表的映射都给拷贝到这个page里面, 这样我们就可以根据这个一级页表去拿到内核的数据了. 听起来是不是很可行!</li><li>为什么要kstack 从procinit移出来呢?</li></ol><p>Scause 对应的错误</p><table><thead><tr><th>异常编码</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td>Instruction address misaligned</td></tr><tr><td>1</td><td>Instruction access fault</td></tr><tr><td>2</td><td>Illegal instruction</td></tr><tr><td>3</td><td>Breakpoint</td></tr><tr><td>4</td><td>Load address misaligned</td></tr><tr><td>5</td><td>Load access fault</td></tr><tr><td>6</td><td>Store/AMO address misaligned</td></tr><tr><td>7</td><td>Store/AMO access fault</td></tr><tr><td>8</td><td>Environment call from U-mode</td></tr><tr><td>9</td><td>Environment call from S-mode</td></tr><tr><td>11</td><td>Environment call from M-mode</td></tr><tr><td>12</td><td>Instruction page fault</td></tr><tr><td>13</td><td>Load page fault</td></tr><tr><td>15</td><td>Store/AMO page fault</td></tr></tbody></table><h4 id=simplify-copyincopyinstr-hardhttpspdoscsailmitedu6s0812020labsguidancehtml>Simplify <code>copyin/copyinstr</code> (<a href=https://pdos.csail.mit.edu/6.S081/2020/labs/guidance.html target=_blank rel="external nofollow noopener noreferrer">hard</a>)</h4><blockquote><p>Replace the body of <code>copyin</code> in <code>kernel/vm.c</code> with a call to <code>copyin_new</code> (defined in <code>kernel/vmcopyin.c</code>); do the same for <code>copyinstr</code> and <code>copyinstr_new</code>. Add mappings for user addresses to each process&rsquo;s kernel page table so that <code>copyin_new</code> and <code>copyinstr_new</code> work. You pass this assignment if <code>usertests</code> runs correctly and all the <code>make grade</code> tests pass.</p></blockquote><ul><li>让copyin函数调用copyin_new 函数, 使其正常运行之后,才继续写copyin_str</li><li>每次当内核需要改变用户页表的时候, 同时改变用户进程的kernel pgtable, 例如fork(),exec(), sbrk()</li><li>不要忘记initcode 进程的修改</li><li>思考在用户进程的kernel pgtable 的PTE权限是什么? (PTE_U 无法在kernel mode 中被访问)</li><li>不要让页表映射高于PLIC limit</li></ul><ol><li>Copyin 函数究竟干了写什么东西</li><li>全部拷贝mappings, 为什么copyin_new 会work起来?</li><li>究竟什么是virtual memory? 如何理解virtual memory的机制? hints: PTE tag</li><li></li></ol><h4 id=optional-challengge-exercises>Optional Challengge exercises</h4><ul><li>取消对用户页表 第一页的映射,当解引用一个null 指针的时候会生成一个page fault.</li><li>使用超级页表 来减少pagetable中PTE的数量</li><li>取消PLIC Limit的限制</li></ul><hr><p>感慨良多呀, 重刷 2020 lab pgtbl , 一个lab 就困了我3天, 最主要的问题就在于对页表的理解 还是太浅薄了 不够深刻, 所以还是写一篇博客来总结一下这几天关于页表的思考, 还是以QA的形式进行记录.</p><ol><li><p>究竟什么是虚拟地址,什么是物理地址呢?</p><p>我们知道所谓的虚拟地址和物理地址都是针对于内存的概念, 所以下面会统称为虚拟内存和物理内存.我的理解是这样的 <code>虚拟内存正如jyy所说的是给用户程序带上的VR眼镜, 构建出一个虚拟的世界让用户程序以为自己独占整个世界</code>,但其实在背后是多个不同的用户程序和内核一起在共享整个内存. 而物理地址则是现实可索引的物理内存index, 在RISC-V中 只要MMU不工作的情况下, 你所接触到的地址都指的是物理地址, 比如xv6刚启动时, PC指向0x8000000 也就是entry.S的entry section, 然后开始执行section里面的指令, 这时候的地址就是物理地址. 直到执行kvminit函数 组装出一个三级页表的kernel_pagetable 并且kvminithart函数使得SATP寄存器指向kernel_pagetable之后,MMU才开始工作,从这一时刻开始 内核也带上VR眼镜, 他所面对的地址也需要经过MMU的翻译, 不过内核有自己摘下VR眼镜的权利(Turn off SATP register),但用户程序就只能永远带上VR眼镜了.</p></li><li><p>在xv6中关于物理地址和虚拟地址的转换计算?</p><p>如果有仔细看过xv6的vmprint的结果的话, 我们会发现xv6的一级页表的512个pte里只有第0、2、255个pte是有值的, 其中pte为0 的物理地址指向二级页表对应的pte 也不是从0开始的, 只有4个pte 分别是16,96,97,128. 如下图所示</p></li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/image-20230306095233389.png data-srcset="/img/image-20230306095233389.png, /img/image-20230306095233389.png 1.5x, /img/image-20230306095233389.png 2x" data-sizes=auto alt=image-20230306095233389 title=image-20230306095233389></p><p>那这究竟是怎么回事呢? 这就需要说到从虚拟地址到物理地址转换的过程, 我们知道在内核中最低的物理地址就是CLINT 0x2000000,</p><p>并且xv6的内核页表是直接映射(也即虚拟地址和物理地址是一样的),那xv6的页表是怎么将虚拟地址0x2000000映射到CLINT的物理地址呢? 这需要对xv6的三级页表的建立过程有所了解, 其里面最核心的逻辑就是walk这个函数, 以上述的0x2000000为例, 我们来说一下三级页表的建立过程, 我们知道在内核看来一个虚拟地址是分成多个部分的, 如下图所示, EXT|L2|L1|L0|Offset, 当页表准备为虚拟地址0x2000000建立映射的时候, 他会将0x2000000 首先转化成一个64位的二进制, 由于xv6是Sv39 所以我们只需要关心后39bits就可以了, 至于前面的bits 在xv6里面都是0,是预留的扩展位. 总所周知一位十六进制数对应着4位二进制数, 那么我们的 0x2000000 就可以换算成 =</p><p>0010,0000,0000,0000,0000,0000,0000 一共28位二进制数, 也即虚拟地址的后28bits, 剩余39-28=11bits都是0, 假设我们按照下图的切割方法,将39bits 分成4团. 则得到L2 000,000,000 | L1 000,010,000 |L0 000,000,000 | offset 000,000,000,000 . 我们把二进制再转换成十进制(PTE是按十进制呈现的) 得到 L2= 0, L1 = 16, L0 = 0, offset = 0;</p><blockquote><p>当xv6拿到L2,L1,L0之后,就可以建立对应的映射, L2= 0, xv6会查看kernel_pagetable[0]所对应的pte 是不是有效值(看PTE_V), 如果pte无效(没有被分配)的话, 则通过kalloc分配一个PGSIZE大小的内存作为一个二级页表(secondLevel pagetable), 并将这个二级页表的物理地址通过一定的权限设置(PTE flags设置)之后,存放在kernel_pagetable[0]处. L1=16,然后xv6会对刚刚分配的二级页表中查这个secondLevel pagetable[16]所存放的pte是否是个有效值, 由于刚分配这个二级页表,所以这个PTE肯定也是无效值, 因此 这个时候也会通过kalloc 分配一个PGSIZE大小的内存作为一个三级页表(thirdLevel pagetable),并将这个三级页表的物理地址经过一定运算之后放回到 secondLevel pagetable[16]. 这时候来到了三级页表 L0=0, xv6会查看thirdLevel pagtable[0] 是否是个有效值, 众所周知刚分配个肯定都是无效值. <strong>因此 xv6会通过kalloc 分配一个PGSIZE大小的内存作为真正存放数据的地方, 然后把这个地方的物理地址经过一定运算之后放回到 thirdLevel pagetable[0]</strong> , <strong>至此 thirdLevel pagetable[0] 就存放着CLINT的物理地址.</strong> 我们也就结束了将虚拟地址0x2000000 映射到物理地址0x2000000的过程, (其他物理也是同理) 我们通过三级页表可以将一个虚拟地址翻译成物理地址了.</p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/image-20230302215441312.png data-srcset="/img/image-20230302215441312.png, /img/image-20230302215441312.png 1.5x, /img/image-20230302215441312.png 2x" data-sizes=auto alt=image-20230302215441312 title=image-20230302215441312></p><p>现在我们就能知道为什么vmprint打印的值为什么这么奇怪了. 那我们知道PLIC的虚拟地址是0xc000000, 对应的28bits 为1100,0000,0000,0000,0000,0000,0000 填充0到39bits 得到 L2=0, L1=96,L0=0,offset=0. 也即一级页表第0项,二级页表第96项,三级页表第0项. 那我们看看内核基址 <em>0x80,000,000</em> 会映射在哪? 我们知道内核基地是8位十六进制也就是32bits, 再把前7bits填充0,得到一个39bits团,得到L2=000,000,010 L1=000,000,000 L0=000,000,000 offset=000,000,000,000. (L2=2,L1=0,L0=0) 这也解释了为什么vmprint的 kernel_table[2]指向的二级页表连续存放了这么多有效的pte. 如果你看这些二级页表指向的三级页表,你会发现这些三级页表也都是满的.</p><ol start=2><li>为什么页表带来了这么高的复杂度, 并且要连续3次访问内存才能拿到一个物理地址,我们还需要虚拟内存呢?</li></ol><p>这是一个好问题, 一个技术的出现肯定是为了解决一些已知问题. 在我看来虚拟内存主要解决了以下几个问题</p><ul><li>内存不足：在使用虚拟内存之前，操作系统需要将所有进程所需的物理内存完全映射到它们的虚拟地址空间中。这样往往会导致内存不足的问题，因为进程的内存需求可能会随着时间变化而变化。虚拟内存可以将进程的虚拟地址空间映射到物理内存上，并且只有当进程需要访问某个页面时才将其加载到物理内存中(<strong>Lazy Load</strong>)。这样可以极大地节省物理内存的使用，从而避免了内存不足的问题。(参考8GB的运行内存,却可以玩16GB的绝地求生游戏)</li><li>大内存需求：某些应用程序需要处理非常大的数据集，超出了实际可用的物理内存大小。虚拟内存技术可以将磁盘上的数据交换到物理内存中，从而允许应用程序使用比实际物理内存更大的内存。(<strong>参考Linux的swap分区</strong>)</li><li>内存保护：虚拟内存技术可以对进程使用的内存进行抽象和保护，防止不同进程之间发生内存冲突或篡改，提高了系统的安全性和稳定性.</li><li>进程隔离：每个进程都有自己的虚拟地址空间，使得多个进程之间相互隔离，从而提高了系统的稳定性和安全性，并且便于进行优化和调度。</li><li>灵活性和扩展性：虚拟内存使得操作系统和应用程序的设计更加灵活和可扩展。由于虚拟内存可以为每个进程提供一个独立的地址空间，因此可以更容易地进行进程切换、共享内存等操作。同时，也使得应用程序可以更好地适应不同的硬件环境和内存大小。</li></ul><p>虚拟内存不仅解决了这些问题, 而且还带来了很多的好处</p><ul><li><p>内存共享：多个进程可以共享同一块物理内存(<strong>只要建立一样的映射就可以了,参考kernel pagetable per process</strong>)，从而实现资源共享，提高系统效率</p></li><li><p>统一内存抽象：虚拟内存使得操作系统可以将物理内存和二级存储器（如磁盘）和一些硬件设备 统一抽象为一组逻辑地址，简化了系统的管理和维护,降低了应用层程序员的心智负担、</p></li><li><p>内存保护：虚拟内存可以将一部分内存区域设置为只读或者不可执行(<strong>设置PTE flag</strong>)，保护系统和应用程序的稳定性和安全性</p></li><li><p>减少内存碎片：在使用虚拟内存的情况下，操作系统可以将物理内存划分为许多大小相等的页面。当一个进程申请内存时，操作系统会分配一定数量的页面来满足该进程的需求，并将这些页面映射到该进程的虚拟地址空间中。当进程不再需要这些页面时，操作系统则会回收它们。 <strong>但是这也会带来IO放大, 比如我只想申请一个8Bytes大小的内存, 我们却需要向操作系统申请一个4KB的内存, 虽然libc 帮我们做了一些工作 减缓了这种现象</strong></p></li><li><p>机制简化：虚拟内存把内存管理从应用层转移到内核层，使得应用程序无需关心物理内存的具体情况，减少了编程复杂度</p></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-03-20 22:33:19">更新于 2023-03-20&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.deniffer.com/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ data-title=xv6内存布局><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.deniffer.com/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.deniffer.com/posts/mit6s081/new/xv6%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ data-title=xv6内存布局><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/mit6s081/new/%E5%89%8D%E8%A8%80lab-utility/ class=post-nav-item rel=prev title=这次是全新的MIT操作系统学习体验><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>这次是全新的MIT操作系统学习体验</a>
<a href=/posts/mit6s081/new/c%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0riscv%E8%99%9A%E6%8B%9F%E6%9C%BA/ class=post-nav-item rel=next title="C语言实现RISCV虚拟机with Chatgpt4">C语言实现RISCV虚拟机with Chatgpt4<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript rel="external nofollow noopener noreferrer">Disqus</a>.</noscript><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/ rel="external nofollow noopener noreferrer">Valine</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.100.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.17-RC"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://blog.deniffer.com target=_blank rel="external nofollow noopener noreferrer">Deniffer</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i>&nbsp;<span class=run-times>网站运行中 ...</span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><div class=reading-progress-bar style=left:0;top:0></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/valine/valine.min.css><script src=https://.disqus.com/embed.js defer></script><script src=/lib/valine/Valine.min.js></script><script src=/lib/lazysizes/lazysizes.min.js async defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:15},comment:{enable:!0,expired:!1,valine:{appId:"kEqDe4xjIfYnEFTRYCGxSVjc-gzGzoHsz",appKey:"7oaG2q6XsD6F46IZsYIwZWnA",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"快来发表你的有趣观点吧!",recordIP:!0,visitor:!0}},siteTime:"2020-12-18T16:15:22+08:00"}</script><script src=/js/theme.min.js defer></script></body></html>